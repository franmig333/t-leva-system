<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>t-leva App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>

    <div class="container" id="app">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="step-indicator">
                <span id="step1Label" style="color: var(--text-color)">Servicios</span>
                <span id="step2Label">Detalles</span>
            </div>
        </div>

        <header id="header">
            <!-- Dynamic Content -->
        </header>

        <form name="t-leva-app" method="POST" data-netlify="true" id="wizardForm" enctype="multipart/form-data">
            <input type="hidden" name="form-name" value="t-leva-app" />
            <input type="hidden" name="selected_services" id="selectedServicesInput">

            <!-- STEP 1: Services -->
            <div class="wizard-step active" id="step1">
                <div id="services-container" class="services-grid">
                    <!-- Loading Skeleton -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px;">Cargando servicios...</div>
                </div>
                <div class="error-msg" id="serviceError">Por favor selecciona al menos un servicio.</div>
                <button type="button" class="action-btn" onclick="nextStep()">Continuar</button>
            </div>

            <!-- STEP 2: Questions -->
            <div class="wizard-step" id="step2">
                <div id="questions-container">
                    <!-- Dynamic Questions from Config -->
                </div>

                <div id="service-specific-container" style="margin-top: 2rem;">
                    <!-- Static Hidden Sections -->

                    <!-- LOGO BLOCK -->
                    <div id="details-logo" class="service-section hidden">
                        <h3 class="section-title">üé® Personalizaci√≥n de Logo</h3>
                        <div class="form-group">
                            <label>¬øQu√© estilo buscas?</label>
                            <div class="select-wrapper">
                                <select name="logo_style" id="logo_style">
                                    <option value="Minimalista">Minimalista</option>
                                    <option value="Lujoso">Lujoso</option>
                                    <option value="Divertido">Divertido</option>
                                    <option value="Geom√©trico">Geom√©trico</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Colores de preferencia</label>
                            <input type="text" name="logo_colors" id="logo_colors" placeholder="Ej: Azul y Dorado">
                        </div>
                        <div class="form-group">
                            <label>Sube referentes visuales</label>
                            <label class="file-upload-wrapper">
                                <input type="file" name="logo_files" multiple>
                                <span>üìÇ Arrastra o clic aqu√≠</span>
                            </label>
                        </div>
                    </div>

                    <!-- WEB BLOCK -->
                    <div id="details-web" class="service-section hidden">
                        <h3 class="section-title">üåê Detalles Web</h3>
                        <div class="form-group">
                            <label>¬øTienes dominio comprado?</label>
                            <div class="select-wrapper">
                                <select name="web_domain" id="web_domain">
                                    <option value="Si">S√≠</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Objetivo de la web</label>
                            <div class="select-wrapper">
                                <select name="web_goal" id="web_goal">
                                    <option value="Reservas/Citas">Reservas/Citas</option>
                                    <option value="Ventas Online">Ventas Online</option>
                                    <option value="Solo Informaci√≥n">Solo Informaci√≥n</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Redes Sociales actuales</label>
                            <textarea name="web_socials" id="web_socials" rows="2"
                                placeholder="Pega tus links aqu√≠"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Sube fotos de tus productos/local</label>
                            <label class="file-upload-wrapper">
                                <input type="file" name="web_files" multiple>
                                <span>üì∑ Arrastra o clic aqu√≠</span>
                            </label>
                        </div>
                    </div>

                    <!-- BIO BLOCK -->
                    <div id="details-bio" class="service-section hidden">
                        <h3 class="section-title">üîó Bio Site</h3>
                        <div class="form-group">
                            <label>¬øQu√© enlaces quieres destacar?</label>
                            <textarea name="bio_links" id="bio_links" rows="3"
                                placeholder="WhatsApp, Direcci√≥n, Cat√°logo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Foto de perfil</label>
                            <label class="file-upload-wrapper">
                                <input type="file" name="bio_profile_pic">
                                <span>üë§ Arrastra o clic aqu√≠</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 2rem;">
                    <button type="button" class="action-btn"
                        style="background-color: transparent; border: 1px solid var(--input-bg); color: #b2bec3;"
                        onclick="prevStep()">Atr√°s</button>
                    <button type="submit" class="action-btn" id="submitBtn">Enviar Solicitud</button>
                </div>
            </div>
        </form>

        <a href="/admin/" class="admin-link">üîí Acceso Administrador</a>
    </div>

    <!-- Configurado para el usuario franmig33 -->
    <script>
        let currentStep = 1;
        const totalSteps = 2;
        const selectedServices = new Set();

        document.addEventListener('DOMContentLoaded', async () => {
            updateProgress();

            updateProgress();

            const form = document.getElementById('wizardForm');
            form.addEventListener('submit', handleSubmit);


            // Redirect to admin if login happens on this page
            if (window.netlifyIdentity) {
                window.netlifyIdentity.on("init", user => {
                    if (!user) {
                        window.netlifyIdentity.on("login", () => {
                            document.location.href = "/admin/";
                        });
                    }
                });
            }

            try {
                const response = await fetch('/_data/config.json');
                if (!response.ok) throw new Error('Error fetching config');
                const data = await response.json();
                renderApp(data);
                window.appConfig = data;
            } catch (error) {
                console.error(error);
                document.getElementById('header').innerHTML = '<h2>Error de conexi√≥n</h2>';
            }
        });

        function renderApp(data) {
            // Header
            // Header
            let logoHtml = '';
            if (data.logo_imagen) {
                logoHtml = `<img id="dynamic-logo" class="app-logo" src="${data.logo_imagen}" alt="Logo Empresa" />`;
            }

            document.getElementById('header').innerHTML = `
                ${logoHtml}
                <h1>${data.title}</h1>
                <p class="subtitle">${data.subtitle}</p>
            `;

            // Apply Dynamic Colors
            if (data.apariencia) {
                const root = document.documentElement;
                if (data.apariencia.color_fondo_app) root.style.setProperty('--bg-color', data.apariencia.color_fondo_app);
                if (data.apariencia.color_primario) {
                    root.style.setProperty('--accent-color', data.apariencia.color_primario);
                }
                if (data.apariencia.color_texto) root.style.setProperty('--text-color', data.apariencia.color_texto);
            }

            // Services
            const servicesContainer = document.getElementById('services-container');
            servicesContainer.innerHTML = ''; // Clear skeleton

            if (data.services) {
                data.services.forEach(service => {
                    const btn = document.createElement('div');
                    btn.className = 'service-card';
                    btn.textContent = service.name;
                    btn.onclick = () => toggleService(btn, service.name);
                    servicesContainer.appendChild(btn);
                });
            }

            // Questions
            const questionsContainer = document.getElementById('questions-container');
            if (data.questions) {
                let html = '';
                data.questions.forEach(q => {
                    const id = q.name || q.label.toLowerCase().replace(/\s+/g, '-');
                    html += `<div class="form-group">
                        <label for="${id}">${q.label}</label>
                        ${q.type === 'textarea'
                            ? `<textarea id="${id}" name="${id}" rows="4" required></textarea>`
                            : `<input type="${q.type}" id="${id}" name="${id}" required>`}
                    </div>`;
                });
                questionsContainer.innerHTML = html;
            }
        }

        function toggleService(element, name) {
            element.classList.toggle('selected');
            if (selectedServices.has(name)) {
                selectedServices.delete(name);
            } else {
                selectedServices.add(name);
            }
            document.getElementById('selectedServicesInput').value = Array.from(selectedServices).join(', ');

            if (selectedServices.size > 0) {
                document.getElementById('serviceError').style.display = 'none';
            }
            // Trigger Conditional Logic
            updateConditionals();
        }

        function updateConditionals() {
            // Logo
            const logoSection = document.getElementById('details-logo');
            if (selectedServices.has('Logo')) {
                logoSection.classList.remove('hidden');
                document.getElementById('logo_colors').required = true;
            } else {
                logoSection.classList.add('hidden');
                document.getElementById('logo_colors').required = false;
            }

            // Web
            const webSection = document.getElementById('details-web');
            if (selectedServices.has('Web')) {
                webSection.classList.remove('hidden');
                document.getElementById('web_socials').required = true;
            } else {
                webSection.classList.add('hidden');
                document.getElementById('web_socials').required = false;
            }

            // Bio
            const bioSection = document.getElementById('details-bio');
            if (selectedServices.has('Bio')) {
                bioSection.classList.remove('hidden');
                document.getElementById('bio_links').required = true;
            } else {
                bioSection.classList.add('hidden');
                document.getElementById('bio_links').required = false;
            }
        }

        window.nextStep = function () {
            if (currentStep === 1) {
                if (selectedServices.size === 0) {
                    document.getElementById('serviceError').style.display = 'block';
                    // Shake animation effect
                    const btn = document.querySelector('#step1 .action-btn');
                    btn.style.transform = 'translateX(5px)';
                    setTimeout(() => btn.style.transform = 'translateX(0)', 100);
                    return;
                }
            }

            if (currentStep < totalSteps) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        };

        window.prevStep = function () {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        };

        async function handleSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Procesando...";
            btn.disabled = true;

            const formData = new FormData(form);

            try {
                // 1. Send to Netlify
                await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                // 2. Build WhatsApp Message
                const company = document.getElementById('company_name')?.value || "Cliente";
                let message = `Hola T-Leva, soy ${company}.%0A%0A`;

                if (selectedServices.has('Web')) {
                    const goal = document.getElementById('web_goal').value;
                    const domain = document.getElementById('web_domain').value;
                    message += `üåê WEB: Objetivo ${goal}, Dominio ${domain}.%0A`;
                }

                if (selectedServices.has('Logo')) {
                    const style = document.getElementById('logo_style').value;
                    const colors = document.getElementById('logo_colors').value;
                    message += `üé® LOGO: Estilo ${style}, Colores ${colors}.%0A`;
                }

                if (selectedServices.has('Bio')) {
                    message += `üîó BIO SITE solicitado.%0A`;
                }

                // Check for files
                const hasFiles = (formData.get('logo_files') && formData.get('logo_files').size > 0) ||
                    (formData.get('web_files') && formData.get('web_files').size > 0) ||
                    (formData.get('bio_profile_pic') && formData.get('bio_profile_pic').size > 0);

                if (hasFiles) {
                    message += `%0A‚úÖ He subido mis archivos de referencia en el formulario.`;
                }

                // 3. Redirect
                const WA_NUMBER = window.appConfig?.contacto?.whatsapp_number || "593999999999";
                window.location.href = `https://wa.me/${WA_NUMBER}?text=${message}`;

            } catch (error) {
                console.error(error);
                btn.innerText = "Error - Intenta de nuevo";
                btn.disabled = false;
            }
        }

        function updateProgress() {
            const percent = ((currentStep - 1) / (totalSteps - 1)) * 100; // 0% or 100% since 2 steps
            // But visual preference usually starts at 50% for step 1? 
            // Let's make Step 1 = 50%, Step 2 = 100% for better visual feedback
            const visualPercent = (currentStep / totalSteps) * 100;

            document.getElementById('progressBar').style.width = `${visualPercent}%`;

            // Update labels styles
            if (currentStep === 2) {
                document.getElementById('step2Label').style.color = 'var(--text-color)';
            } else {
                document.getElementById('step2Label').style.color = '#b2bec3';
            }
        }
    </script>
</body>

</html>